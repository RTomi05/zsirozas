<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Zsírozás</title>

<style>
body {
    background:#063;
    font-family: Arial;
    color:white;
}

.hand, .table {
    display:flex;
    gap:10px;
    margin:10px 0;
    flex-wrap: wrap;
}


.card {
    width:200px;
    height:280px;
    border-radius:10px;
    cursor:pointer;
    border:2px solid transparent;
}

.card img {
    width:100%;
    height:100%;
    border-radius:10px;
}

.card:hover {
    border: 3px solid blue;
}

.disabled {
    opacity:0.4;
    pointer-events:none;
}

.area {
    background:#0005;
    padding:10px;
    border-radius:8px;
    margin-bottom:20px;
}

.table-area {
    position: relative;
    display: flex;
    align-items: center;  
}

.table-area .table {
    flex: 1 1 auto;
}

#passBtn {
    height: 60px;
    width: 120px;
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    padding:8px 14px;
    background:#ffffff;
    border:none;
    border-radius:5px;
    color:rgb(0, 0, 0);
    font-weight:bold;
    cursor:pointer;
    display: none; 
    z-index: 10;
    margin-left: 500px;
}
</style>
</head>

<body>

<h1>Zsírozás - Projektmunka</h1>
<h1>MOST MÁR NEM TUDSZ HÜLYESÉGET RAKNI! (DE AZÉRT NE PRÓBÁLD MEG)</h1>
<h1 id="jatekVegeKiir" style="text-align: center;"></h1>
<h1 id="gyoztesKiir" style="text-align: center;"></h1>
<h1 id="pontokAVegen" style="text-align: center;"></h1>
<div class="area">
    <b>Aktív játékos:</b> <span id="player"></span>
    
    <div id="scores" style="margin-top:8px">J1: 0 — J2: 0 (Összesen: 0/8)</div>
    <div id="roundInfo" style="margin-top:4px; font-style:italic;"></div>
</div>

<h3>Játékos 1</h3>
<div class="hand" id="hand0"></div>

<h3>Asztal</h3>
<div class="table-area">
    <div class="table" id="table"></div>
    <button id="passBtn" class="passzbtn" onclick="passz()">Passz</button>
</div>

<h3>Játékos 2</h3>
<div class="hand" id="hand1"></div>

<script>
const szinek = ["zöld","szív","tök","makk"];
const ertekek = ["7","8","9","10","alsó","felső","király","ász"];

const szin = {
    "zöld": "level",
    "szív": "sziv",
    "tök": "tok",
    "makk": "makk"
};

const ertek = {
    "7":"7",
    "8":"8",
    "9":"9",
    "10":"10",
    "alsó":"also",
    "felső":"felso",
    "király":"kiraly",
    "ász":"asz"
};

function kartyakep(c){
    return `kartyak/${szin[c.s]}${ertek[c.v]}.png`;
}

let pakli = [];
let kezek = [[], []];
let asztal = [];
let aktualis = 0;
let korKezdo = 1;
let pontok = [0, 0];
let lastAttacker = null; // tracks who played the last successful hit
const MAX_PONTOK = 80;

function kartyaPont(c){
    return (c.v === "10" || c.v === "ász") ? 10 : 0;
}

function paklitad(){
    pakli = [];
    szinek.forEach(s => {
        ertekek.forEach(v => {
            pakli.push({s, v});
        });
    });
}

function kever(a){
    for(let i = a.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
}

function oszt(){
    kezek[0] = [];
    kezek[1] = [];
    for(let i = 0; i < 4; i++){
        if(pakli.length > 0) kezek[0].push(pakli.pop());
        if(pakli.length > 0) kezek[1].push(pakli.pop());
    }
}

function utolap(card1, card2){

    return card2.v === "7" || card2.v === card1.v || card1.v === "7";
}

function vanUtolapja(jatekos, utendoLap){
   
    return kezek[jatekos].some(c => utolap(utendoLap, c));
}

function huz(jatekos){
    while(pakli.length > 0 && kezek[jatekos].length < 4){
        kezek[jatekos].push(pakli.pop());
    }
}

function equalDraw(player1, player2){
    // Draw up to 4 for each player; if not enough cards, distribute equally
    const cardsNeeded = 8 - (kezek[player1].length + kezek[player2].length);
    const cardsAvailable = pakli.length;
    
    if(cardsAvailable >= cardsNeeded) {
        // Enough cards, use regular draw
        huz(player1);
        huz(player2);
    } else {
        // Not enough cards, distribute equally
        const cardsPerPlayer = Math.floor(cardsAvailable / 2);
        for(let i = 0; i < cardsPerPlayer; i++) {
            if(pakli.length > 0) kezek[player1].push(pakli.pop());
            if(pakli.length > 0) kezek[player2].push(pakli.pop());
        }
    }
}

function passz(){

    // Allow pass on 2, 4, or 6 card tables
    if(asztal.length !== 2 && asztal.length !== 4 && asztal.length !== 6) return;
    if(aktualis !== korKezdo) return;

    // Check for hit based on table length
    let hasHit = false;
    if(asztal.length === 2){
        hasHit = utolap(asztal[0], asztal[1]);
    } else if(asztal.length === 4 || asztal.length === 6){
        hasHit = true; // If we got here with 4/6 cards, there was a hit chain
    }
    
    if(!hasHit) return;

    // For 2-card case: check double-seven rule
    if(asztal.length === 2){
        const isDoubleSeven = asztal[0].v === "7" && asztal[1].v === "7";
        const hasSevenInHand = kezek[aktualis].some(c => c.v === "7");
        if(isDoubleSeven && !hasSevenInHand){
            return;
        }
    }
    
    // Check if current player has a valid hit card
    const last = asztal[asztal.length - 1];
    let hasValid = vanUtolapja(aktualis, last);
    
    // New rule: cannot choose pass if the current player has no valid hit
    if(!hasValid) {
        return;
    }
    
    
    const winner = 1 - korKezdo;
    const points = asztal.reduce((sum, c) => sum + kartyaPont(c), 0);
    pontok[winner] += points;
    
    document.getElementById("roundInfo").textContent = 
        `Passz! Játékos ${winner+1} viszi a lapokat, (${points} pont).`;
    
   
    equalDraw(winner, 1 - winner);
    
   
    korKezdo = winner;
    aktualis = korKezdo;
    asztal = [];
    lastAttacker = null;
    
    if(jatekVege()) return;
    frissit();
}

function jatekVege(){
    if(pakli.length === 0 && (kezek[0].length === 0 || kezek[1].length === 0)){
        for(let p = 0; p < 2; p++){
            if(kezek[p].length > 0 && kezek[p].every(c => c.v === "7")){
                const masik = 1 - p;
                alert(`Játék vége! Játékos ${p+1} veszített, mert csak hetesei maradtak. Játékos ${masik+1} nyert!`);
                document.querySelectorAll('.hand .card').forEach(c => c.classList.add('disabled'));
                document.getElementById("passBtn").style.display = "none";
                return true;
            }
        }
        
        const winner = pontok[0] > pontok[1] ? 1 : (pontok[1] > pontok[0] ? 2 : 0);
        if(winner === 0){
            frissit();
            roundInfo.textContent = "Véget ért a játék.";
            document.getElementById("gyoztesKiir").textContent = `A játék véget ért! \tDöntetlen!`;
            document.getElementById("pontokAVegen").textContent = `Játékos 1: ${pontok[0]} pont — Játékos 2: ${pontok[1]} pont. Az utolsó ütést vivő játékos nyer!`;
            //alert(`A játék véget ért! Döntetlen: Játékos 1: ${pontok[0]} pont — Játékos 2: ${pontok[1]} pont. Az utolsó ütést vivő játékos nyer!`);

        } else {
            frissit();
            roundInfo.textContent = "Véget ért a játék.";
            document.getElementById("jatekVegeKiir").textContent = `A játék véget ért!`;
            document.getElementById("gyoztesKiir").textContent = `Győztes: Játékos ${winner}`;
            document.getElementById("pontokAVegen").textContent = `Játékos 1: ${pontok[0]} pont \t — Játékos 2: ${pontok[1]} pont`;
            //alert(`A játék véget ért! \nGyőztes: Játékos ${winner}\nJátékos 1: ${pontok[0]} pont — Játékos 2: ${pontok[1]} pont`);
        }
        document.querySelectorAll('.hand .card').forEach(c => c.classList.add('disabled'));
        document.getElementById("passBtn").style.display = "none";
        return true;
    }
    return false;
}

function jatszik(p, idx){
    if(p !== aktualis){
        alert("Nem te következel!");
        return;
    }

    const card = kezek[p][idx];

    // first card always allowed
    if(asztal.length === 0){
        asztal.push(card);
        kezek[p].splice(idx, 1);
        korKezdo = p;
        lastAttacker = p;
        aktualis = 1 - p;
        frissit();
        return;
    }

    // second card: check for ütéssel
    if(asztal.length === 1){
        asztal.push(card);
        kezek[p].splice(idx, 1);

        if(utolap(asztal[0], asztal[1])){
            // hit occurred, starter may continue or pass
            lastAttacker = korKezdo;
            document.getElementById("roundInfo").textContent = "Ütés! A kör kezdője üthet tovább vagy passzolhat.";
            aktualis = korKezdo;
        } else {
            // no hit, round starter takes the cards
            const winner = korKezdo;
            const points = asztal.reduce((sum, c) => sum + kartyaPont(c), 0);
            pontok[winner] += points;

            document.getElementById("roundInfo").textContent = 
                `Játékos ${winner+1} viszi a lapokat, (${points} pont).`;

            equalDraw(winner, 1 - winner);

            korKezdo = winner;
            aktualis = korKezdo;
            asztal = [];
            lastAttacker = null;

            if(jatekVege()) return;
        }
        frissit();
        return;
    }

    // beyond two cards, we are in a hit chain; each play is allowed but may end the trick
    const prev = asztal[asztal.length - 1];
    const isHit = utolap(prev, card);

    asztal.push(card);
    kezek[p].splice(idx, 1);

    if(isHit){
        // update who last hit
        lastAttacker = p;
        aktualis = 1 - p;
        // provide helpful message depending on whose turn is next
        if(p === korKezdo) {
            document.getElementById("roundInfo").textContent = "Ütés! A kör kezdője üthet tovább vagy passzolhat.";
        } else {
            document.getElementById("roundInfo").textContent = "Ütés! A másik játékos üthet tovább vagy passzolhat.";
        }
        frissit();
        return;
    } else {
        // chain breaks, lastAttacker wins the trick
        const winner = lastAttacker !== null ? lastAttacker : korKezdo;
        const points = asztal.reduce((sum, c) => sum + kartyaPont(c), 0);
        pontok[winner] += points;

        document.getElementById("roundInfo").textContent = 
            `Játékos ${winner+1} viszi a lapokat, (${points} pont).`;

        equalDraw(winner, 1 - winner);

        korKezdo = winner;
        aktualis = korKezdo;
        asztal = [];
        lastAttacker = null;

        if(jatekVege()) return;
        frissit();
        return;
    }
}

function kartyaElem(c, p, i){
    const d = document.createElement("div");
    d.className = "card";

    const img = document.createElement("img");
    img.src = kartyakep(c);
    img.alt = `${c.s} ${c.v}`;

    d.appendChild(img);

    if(p !== undefined) d.onclick = () => jatszik(p, i);
    return d;
}

function frissit(){
    document.getElementById("player").textContent = "Játékos " + (aktualis + 1);

    document.getElementById("table").innerHTML = "";
    document.getElementById("hand0").innerHTML = "";
    document.getElementById("hand1").innerHTML = "";

    asztal.forEach(c => {
        document.getElementById("table").appendChild(kartyaElem(c));
    });

    kezek.forEach((h, p) => {
        h.forEach((c, i) => {
            const d = kartyaElem(c, p, i);
            if(p !== aktualis) d.classList.add("disabled");
            document.getElementById("hand" + p).appendChild(d);
        });
    });
    
    const scoresEl = document.getElementById("scores");
    if(scoresEl){
        const total = pontok[0] + pontok[1];
        scoresEl.textContent = `J1: ${pontok[0]} — J2: ${pontok[1]} (Összesen: ${total}/${MAX_PONTOK})`;
    }
    const roundInfo = document.getElementById("roundInfo");
    const passBtn = document.getElementById("passBtn");
    if(asztal.length === 2 && utolap(asztal[0], asztal[1]) && aktualis === korKezdo) {  
        const isDoubleSeven = asztal[0].v === "7" && asztal[1].v === "7";
        const hasSevenInHand = kezek[aktualis].some(c => c.v === "7");
        const autoPassSeven = isDoubleSeven && !hasSevenInHand;
        const equalHands = kezek[0].length === kezek[1].length;
        const anyEmptyHands = kezek[0].length === 0 || kezek[1].length === 0;
        let hasValid = vanUtolapja(aktualis, asztal[1]);
        if(autoPassSeven) {
            hasValid = false;
        }

        // If either player has no cards left, automatic pass should occur
        if(anyEmptyHands) {
            passBtn.style.display = "none";
            roundInfo.textContent = "Nincs több lap a kezekben - automatikus passz.";
            setTimeout(() => {
                if(asztal.length === 2 && utolap(asztal[0], asztal[1]) && aktualis === korKezdo) {
                    const winner = 1 - korKezdo;
                    const points = asztal.reduce((sum, c) => sum + kartyaPont(c), 0);
                    pontok[winner] += points;
                    roundInfo.textContent = `Automatikus passz! Játékos ${winner+1} viszi a lapokat, (${points} pont).`;
                    equalDraw(winner, 1 - winner);
                    korKezdo = winner;
                    aktualis = korKezdo;
                    asztal = [];
                    if(!jatekVege()) frissit();
                }
            }, 300);
        }
        // If there is no valid hit and hands are equal -> automatic pass (existing behaviour)
        else if(!hasValid && equalHands) {
            if(autoPassSeven) console.log("Nincs hetese, automatikus passz!");
            else console.log("Nincs ütőlap, automatikus passz!");
            roundInfo.textContent = autoPassSeven ?
                "Nincs hetese - automatikus passz!" :
                "Nincs ütőlap - automatikus passz!";
            passBtn.style.display = "none";
            setTimeout(() => {
                if(asztal.length === 2 && utolap(asztal[0], asztal[1]) && aktualis === korKezdo) {
                    const winner = 1 - korKezdo;
                    const points = asztal.reduce((sum, c) => sum + kartyaPont(c), 0);
                    pontok[winner] += points;
                    roundInfo.textContent = autoPassSeven ?
                        `Automatikus passz (nincs hetes)! Játékos ${winner+1} viszi a lapokat, (${points} pont).` :
                        `Automatikus passz! Játékos ${winner+1} viszi a lapokat, (${points} pont).`;
                    equalDraw(winner, 1 - winner);
                    korKezdo = winner;
                    aktualis = korKezdo;
                    asztal = [];
                    if(!jatekVege()) frissit();
                }
            }, 500);
        }
        // If there is no valid hit and hands are NOT equal -> force a play (tenni) then automatic pass
        else if(!hasValid) {
            passBtn.style.display = "none";
            roundInfo.textContent = autoPassSeven ?
                "Nincs hetese - kötelező tenni, majd automatikus passz." :
                "Nincs ütőlap - kötelező tenni, majd automatikus passz.";
            setTimeout(() => {
                if(asztal.length === 2 && aktualis === korKezdo && !vanUtolapja(aktualis, asztal[1])){
                    // force the current player to put their first available card
                    if(kezek[aktualis].length > 0){
                        const forced = kezek[aktualis].shift();
                        asztal.push(forced);
                    }
                    // resolve immediately as a chain-break (automatic pass)
                    const winner = lastAttacker !== null ? lastAttacker : korKezdo;
                    const points = asztal.reduce((sum, c) => sum + kartyaPont(c), 0);
                    pontok[winner] += points;
                    roundInfo.textContent = `Automatikus passz! Játékos ${winner+1} viszi a lapokat, (${points} pont).`;
                    equalDraw(winner, 1 - winner);
                    korKezdo = winner;
                    aktualis = korKezdo;
                    asztal = [];
                    lastAttacker = null;
                    if(!jatekVege()) frissit();
                }
            }, 400);
        } else {
            passBtn.style.display = "inline-block";
            passBtn.disabled = false;
            roundInfo.textContent = "Ütés! Van ütőlapod - továbbüthetsz vagy passzolhatsz.";
        }
    } else {
        passBtn.style.display = "none";
        passBtn.disabled = true;

        // Special handling for 4 cards on table: auto-pass if current player has no hit,
        // otherwise allow manual pass via button.
        if(asztal.length === 4){
            const last = asztal[asztal.length - 1];
            const hasValid = vanUtolapja(aktualis, last);
            if(!hasValid){
                roundInfo.textContent = "Nincs ütőlapod a 4 lapon - automatikus passz.";
                setTimeout(() => {
                    if(asztal.length === 4){
                        const winner = lastAttacker !== null ? lastAttacker : korKezdo;
                        const points = asztal.reduce((sum, c) => sum + kartyaPont(c), 0);
                        pontok[winner] += points;
                        roundInfo.textContent = `Automatikus passz! Játékos ${winner+1} viszi a lapokat, (${points} pont).`;
                        equalDraw(winner, 1 - winner);
                        korKezdo = winner;
                        aktualis = korKezdo;
                        asztal = [];
                        lastAttacker = null;
                        if(!jatekVege()) frissit();
                    }
                }, 350);
            } else {
                passBtn.style.display = "inline-block";
                passBtn.disabled = false;
                roundInfo.textContent = "4 lap az asztalon - van ütőlapod: továbbüthetsz vagy passzolhatsz.";
            }
            return;
        }
        // Special handling for 6 cards on table: auto-pass if current player has no hit,
        // otherwise allow manual pass via button.
        if(asztal.length === 6){
            const last = asztal[asztal.length - 1];
            const hasValid = vanUtolapja(aktualis, last);
            if(!hasValid){
                roundInfo.textContent = "Nincs ütőlapod a 6 lapon - automatikus passz.";
                setTimeout(() => {
                    if(asztal.length === 6){
                        const winner = lastAttacker !== null ? lastAttacker : korKezdo;
                        const points = asztal.reduce((sum, c) => sum + kartyaPont(c), 0);
                        pontok[winner] += points;
                        roundInfo.textContent = `Automatikus passz! Játékos ${winner+1} viszi a lapokat, (${points} pont).`;
                        equalDraw(winner, 1 - winner);
                        korKezdo = winner;
                        aktualis = korKezdo;
                        asztal = [];
                        lastAttacker = null;
                        if(!jatekVege()) frissit();
                    }
                }, 350);
            } else {
                passBtn.style.display = "inline-block";
                passBtn.disabled = false;
                roundInfo.textContent = "6 lap az asztalon - van ütőlapod: továbbüthetsz vagy passzolhatsz.";
            }
            return;
        }
        // Special handling for 8 cards on table: always automatic pass
        if(asztal.length === 8){
            roundInfo.textContent = "8 lap az asztalon - automatikus passz.";
            setTimeout(() => {
                if(asztal.length === 8){
                    const winner = lastAttacker !== null ? lastAttacker : korKezdo;
                    const points = asztal.reduce((sum, c) => sum + kartyaPont(c), 0);
                    pontok[winner] += points;
                    roundInfo.textContent = `Automatikus passz! Játékos ${winner+1} viszi a lapokat, (${points} pont).`;
                    equalDraw(winner, 1 - winner);
                    korKezdo = winner;
                    aktualis = korKezdo;
                    asztal = [];
                    lastAttacker = null;
                    if(!jatekVege()) frissit();
                }
            }, 350);
            return;
        }

        if(asztal.length === 1){
            roundInfo.textContent = "Válasszon lapot a másik játékos!";
        } else if(asztal.length === 2){
            if(utolap(asztal[0], asztal[1])){
                if(aktualis !== korKezdo) {
                    roundInfo.textContent = "Ütés! A kör kezdője üthet tovább!";
                }
            } else {
                roundInfo.textContent = "Nem ütés, a kör kezdője viszi a lapokat!";
            }
        } else if(asztal.length %2 !== 0 && asztal.length > 0){
            roundInfo.textContent = "Tegyél még egy lapot! "; //(4. lapos, utolsó lap, bármit tehetsz)
        } else if(asztal.length === 0){
            roundInfo.textContent = "Új kör kezdődik.";
        }
    }
}

paklitad();
kever(pakli);
oszt();
aktualis = korKezdo;
frissit();
</script>

</body>
</html>